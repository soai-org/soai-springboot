<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>User Management Test</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        button { margin-left: 5px; }
        form { margin-top: 20px; }
        input { margin-right: 5px; }
    </style>
</head>
<body>
<h1>User Management Test</h1>

<!-- Add User Form -->
<h2>Add User</h2>
<form id="addUserForm">
    <input type="text" id="newUserId" placeholder="User ID" required>
    <input type="text" id="newUserName" placeholder="Name" required>
    <input type="text" id="newUserRole" placeholder="Role" required>
    <input type="password" id="newUserPassword" placeholder="Password" required>
    <button type="submit">Add</button>
</form>

<!-- User Table -->
<h2>User List</h2>
<table>
    <thead>
    <tr>
        <th>User ID</th>
        <th>Name</th>
        <th>Role</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="userTableBody"></tbody>
</table>

<script>
    // Load Users
    async function loadUsers() {
        const response = await fetch('/users/list');
        const users = await response.json();
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.userId}</td>
                <td>${user.userName}</td>
                <td>${user.userRole}</td>
                <td>
                    <button onclick="editUser('${user.userId}', '${user.userName}', '${user.userRole}')">Edit</button>
                    <button onclick="deleteUser('${user.userId}')">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Add User
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = {
            userId: document.getElementById('newUserId').value,
            userName: document.getElementById('newUserName').value,
            userRole: document.getElementById('newUserRole').value,
            userPassword: document.getElementById('newUserPassword').value
        };
        const response = await fetch('/users/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
        });
        if(response.ok) {
            alert('User added');
            loadUsers();
        } else {
            alert('Failed to add user');
        }
    });

    // Edit User
    async function editUser(userId, currentName, currentRole) {
        // Edit form HTML
        const editFormHTML = `
            <div id="editModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
                <div style="background: white; padding: 20px; border-radius: 8px; width: 400px;">
                    <h3>사용자 수정</h3>
                    <form id="editUserForm">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">User ID:</label>
                            <input type="text" id="editUserId" value="${userId}" readonly style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #f5f5f5;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Name (비워두면 변경하지 않음):</label>
                            <input type="text" id="editUserName" value="${currentName}" placeholder="새 이름" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Role:</label>
                            <select id="editUserRole" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="USER" ${currentRole === 'USER' ? 'selected' : ''}>USER</option>
                                <option value="ADMIN" ${currentRole === 'ADMIN' ? 'selected' : ''}>ADMIN</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">New Password (비워두면 변경하지 않음):</label>
                            <input type="password" id="editUserPassword" placeholder="새 비밀번호" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div style="text-align: right;">
                            <button type="button" onclick="closeEditModal()" style="padding: 8px 16px; margin-right: 10px; border: 1px solid #ccc; background: #f5f5f5; border-radius: 4px; cursor: pointer;">취소</button>
                            <button type="submit" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">수정</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', editFormHTML);
        
        // Handle form submission
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newName = document.getElementById('editUserName').value;
            const newRole = document.getElementById('editUserRole').value;
            const newPassword = document.getElementById('editUserPassword').value;
            
            const user = { 
                userId, 
                userName: newName.trim() === '' ? '' : newName, 
                userRole: newRole, 
                userPassword: newPassword.trim() === '' ? '' : newPassword 
            };
            
            const response = await fetch('/users/edit', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(user)
            });
            
            if(response.ok) {
                alert('사용자가 수정되었습니다');
                closeEditModal();
                loadUsers();
            } else {
                alert('사용자 수정에 실패했습니다');
            }
        });
    }
    
    // Close edit modal
    function closeEditModal() {
        const modal = document.getElementById('editModal');
        if (modal) {
            modal.remove();
        }
    }

    // Delete User
    async function deleteUser(userId) {
        const confirmed = confirm(`Delete user ${userId}?`);
        if(!confirmed) return;

        const response = await fetch(`/users/delete/${userId}`, { method: 'DELETE' });
        if(response.ok) {
            alert('User deleted');
            loadUsers();
        } else {
            alert('Failed to delete user');
        }
    }

    // Initial load
    loadUsers();
</script>
</body>
</html>
